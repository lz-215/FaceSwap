# 数据库修复说明

## 问题总结

您遇到的两个主要问题：

1. **user_profiles表缺少email字段** - 需要从auth.users中获取email数据
2. **前端积分加载失败** - 缺少`get_user_credits_v2`函数和积分初始化逻辑
3. **订阅状态更新问题** - 需要确保webhook能正确更新user_profiles表

## 解决方案

我已经创建了完整的修复方案，包括：

### 1. 数据库迁移文件
- 📄 `supabase/migrations/20241201000000_fix_user_profiles_and_credits.sql`
- 完整的SQL脚本，包含所有必要的表结构修改和函数创建

### 2. API端点
- 📄 `src/app/api/database/migrate/route.ts`
- 可通过HTTP POST请求执行数据库修复

### 3. Node.js脚本
- 📄 `scripts/fix-database-issues.js`
- 独立的修复脚本，可直接运行

### 4. TypeScript类型更新
- 📄 `src/lib/database-types.ts`
- 已添加email字段到UserProfile接口

## 执行修复

### 方法一：运行Node.js脚本（推荐）

```bash
# 确保安装了依赖
npm install @supabase/supabase-js

# 运行修复脚本
node scripts/fix-database-issues.js
```

### 方法二：使用API端点

```bash
# 发送POST请求到修复端点
curl -X POST http://localhost:3000/api/database/migrate \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_USER_TOKEN"
```

### 方法三：直接执行SQL迁移

如果您有Supabase Dashboard访问权限：

1. 打开Supabase Dashboard
2. 进入SQL Editor
3. 复制`supabase/migrations/20241201000000_fix_user_profiles_and_credits.sql`中的内容
4. 执行SQL脚本

## 修复内容详细说明

### 1. user_profiles表修改

```sql
-- 添加email字段
ALTER TABLE user_profiles ADD COLUMN email TEXT;
CREATE INDEX idx_user_profiles_email ON user_profiles(email);

-- 从auth.users同步email
UPDATE user_profiles 
SET email = auth_users.email, updated_at = NOW()
FROM auth.users AS auth_users 
WHERE user_profiles.id = auth_users.id;
```

### 2. 积分系统函数

创建了以下数据库函数：

- `get_user_credits_v2(p_user_id UUID)` - 获取用户积分信息
- `consume_credits_v2(...)` - 消费积分
- `recharge_credits_v2(...)` - 充值积分
- `get_credits(user_id UUID)` - 简化的积分查询（兼容旧版本）
- `use_credits(user_id UUID, amount INTEGER)` - 简化的积分消费（兼容旧版本）

### 3. 积分初始化

- 为所有现有用户创建初始积分记录（5积分）
- 确保新用户注册时自动获得初始积分
- 修复积分交易记录

### 4. 订阅状态同步

webhook代码已经包含了同步逻辑：

```typescript
// 同步 user_profiles 表 subscription_status 字段
const { error: statusUpdateError } = await supabase
  .from("user_profiles")
  .update({ 
    subscription_status: subscription.status, 
    updated_at: new Date().toISOString() 
  })
  .eq("id", userId);
```

## 验证修复结果

修复完成后，请验证：

### 1. 检查user_profiles表

```sql
-- 验证email字段存在
SELECT column_name FROM information_schema.columns 
WHERE table_name = 'user_profiles' AND column_name = 'email';

-- 验证email数据已同步
SELECT id, email, display_name FROM user_profiles LIMIT 5;
```

### 2. 测试积分函数

```sql
-- 测试积分查询
SELECT get_user_credits_v2('your-user-id'::uuid);

-- 验证积分记录
SELECT * FROM user_credit_balance LIMIT 5;
```

### 3. 前端测试

- 登录应用，检查积分是否正常显示
- 进行人脸交换操作，验证积分消费
- 测试订阅流程，确认状态更新

## 常见问题

### Q: 脚本执行失败怎么办？

**A:** 检查以下项目：

1. 环境变量是否正确设置：
   ```bash
   echo $NEXT_PUBLIC_SUPABASE_URL
   echo $SUPABASE_SERVICE_ROLE_KEY
   ```

2. Supabase服务角色密钥权限是否足够

3. 数据库连接是否正常

### Q: 前端仍然无法加载积分？

**A:** 请检查：

1. 前端是否使用了正确的函数名（`get_user_credits_v2`）
2. 用户是否已登录且有有效的session
3. 浏览器开发者工具中的网络请求和错误信息

### Q: 订阅状态未更新？

**A:** 请检查：

1. Stripe webhook是否正确配置
2. webhook端点是否能正常接收事件
3. 用户ID映射是否正确（检查customer metadata）

## 技术支持

如果遇到问题，请查看：

1. 应用日志（服务器控制台）
2. Supabase Dashboard中的日志
3. Stripe Dashboard中的webhook日志

### 日志位置

- **应用日志**: 服务器控制台输出
- **Supabase日志**: Dashboard → Logs
- **Stripe日志**: Dashboard → Developers → Webhooks → [Your Endpoint]

---

## 总结

此修复方案将彻底解决：

✅ **user_profiles表缺少email字段**  
✅ **前端积分加载失败**  
✅ **积分系统初始化问题**  
✅ **订阅状态更新问题**  

修复后，您的应用将拥有完整可靠的用户配置和积分系统。 