# æ•°æ®åº“ä¿®å¤è¯´æ˜

## é—®é¢˜æ€»ç»“

æ‚¨é‡åˆ°çš„ä¸¤ä¸ªä¸»è¦é—®é¢˜ï¼š

1. **user_profilesè¡¨ç¼ºå°‘emailå­—æ®µ** - éœ€è¦ä»auth.usersä¸­è·å–emailæ•°æ®
2. **å‰ç«¯ç§¯åˆ†åŠ è½½å¤±è´¥** - ç¼ºå°‘`get_user_credits_v2`å‡½æ•°å’Œç§¯åˆ†åˆå§‹åŒ–é€»è¾‘
3. **è®¢é˜…çŠ¶æ€æ›´æ–°é—®é¢˜** - éœ€è¦ç¡®ä¿webhookèƒ½æ­£ç¡®æ›´æ–°user_profilesè¡¨

## è§£å†³æ–¹æ¡ˆ

æˆ‘å·²ç»åˆ›å»ºäº†å®Œæ•´çš„ä¿®å¤æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š

### 1. æ•°æ®åº“è¿ç§»æ–‡ä»¶
- ğŸ“„ `supabase/migrations/20241201000000_fix_user_profiles_and_credits.sql`
- å®Œæ•´çš„SQLè„šæœ¬ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦çš„è¡¨ç»“æ„ä¿®æ”¹å’Œå‡½æ•°åˆ›å»º

### 2. APIç«¯ç‚¹
- ğŸ“„ `src/app/api/database/migrate/route.ts`
- å¯é€šè¿‡HTTP POSTè¯·æ±‚æ‰§è¡Œæ•°æ®åº“ä¿®å¤

### 3. Node.jsè„šæœ¬
- ğŸ“„ `scripts/fix-database-issues.js`
- ç‹¬ç«‹çš„ä¿®å¤è„šæœ¬ï¼Œå¯ç›´æ¥è¿è¡Œ

### 4. TypeScriptç±»å‹æ›´æ–°
- ğŸ“„ `src/lib/database-types.ts`
- å·²æ·»åŠ emailå­—æ®µåˆ°UserProfileæ¥å£

## æ‰§è¡Œä¿®å¤

### æ–¹æ³•ä¸€ï¼šè¿è¡ŒNode.jsè„šæœ¬ï¼ˆæ¨èï¼‰

```bash
# ç¡®ä¿å®‰è£…äº†ä¾èµ–
npm install @supabase/supabase-js

# è¿è¡Œä¿®å¤è„šæœ¬
node scripts/fix-database-issues.js
```

### æ–¹æ³•äºŒï¼šä½¿ç”¨APIç«¯ç‚¹

```bash
# å‘é€POSTè¯·æ±‚åˆ°ä¿®å¤ç«¯ç‚¹
curl -X POST http://localhost:3000/api/database/migrate \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_USER_TOKEN"
```

### æ–¹æ³•ä¸‰ï¼šç›´æ¥æ‰§è¡ŒSQLè¿ç§»

å¦‚æœæ‚¨æœ‰Supabase Dashboardè®¿é—®æƒé™ï¼š

1. æ‰“å¼€Supabase Dashboard
2. è¿›å…¥SQL Editor
3. å¤åˆ¶`supabase/migrations/20241201000000_fix_user_profiles_and_credits.sql`ä¸­çš„å†…å®¹
4. æ‰§è¡ŒSQLè„šæœ¬

## ä¿®å¤å†…å®¹è¯¦ç»†è¯´æ˜

### 1. user_profilesè¡¨ä¿®æ”¹

```sql
-- æ·»åŠ emailå­—æ®µ
ALTER TABLE user_profiles ADD COLUMN email TEXT;
CREATE INDEX idx_user_profiles_email ON user_profiles(email);

-- ä»auth.usersåŒæ­¥email
UPDATE user_profiles 
SET email = auth_users.email, updated_at = NOW()
FROM auth.users AS auth_users 
WHERE user_profiles.id = auth_users.id;
```

### 2. ç§¯åˆ†ç³»ç»Ÿå‡½æ•°

åˆ›å»ºäº†ä»¥ä¸‹æ•°æ®åº“å‡½æ•°ï¼š

- `get_user_credits_v2(p_user_id UUID)` - è·å–ç”¨æˆ·ç§¯åˆ†ä¿¡æ¯
- `consume_credits_v2(...)` - æ¶ˆè´¹ç§¯åˆ†
- `recharge_credits_v2(...)` - å……å€¼ç§¯åˆ†
- `get_credits(user_id UUID)` - ç®€åŒ–çš„ç§¯åˆ†æŸ¥è¯¢ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰
- `use_credits(user_id UUID, amount INTEGER)` - ç®€åŒ–çš„ç§¯åˆ†æ¶ˆè´¹ï¼ˆå…¼å®¹æ—§ç‰ˆæœ¬ï¼‰

### 3. ç§¯åˆ†åˆå§‹åŒ–

- ä¸ºæ‰€æœ‰ç°æœ‰ç”¨æˆ·åˆ›å»ºåˆå§‹ç§¯åˆ†è®°å½•ï¼ˆ5ç§¯åˆ†ï¼‰
- ç¡®ä¿æ–°ç”¨æˆ·æ³¨å†Œæ—¶è‡ªåŠ¨è·å¾—åˆå§‹ç§¯åˆ†
- ä¿®å¤ç§¯åˆ†äº¤æ˜“è®°å½•

### 4. è®¢é˜…çŠ¶æ€åŒæ­¥

webhookä»£ç å·²ç»åŒ…å«äº†åŒæ­¥é€»è¾‘ï¼š

```typescript
// åŒæ­¥ user_profiles è¡¨ subscription_status å­—æ®µ
const { error: statusUpdateError } = await supabase
  .from("user_profiles")
  .update({ 
    subscription_status: subscription.status, 
    updated_at: new Date().toISOString() 
  })
  .eq("id", userId);
```

## éªŒè¯ä¿®å¤ç»“æœ

ä¿®å¤å®Œæˆåï¼Œè¯·éªŒè¯ï¼š

### 1. æ£€æŸ¥user_profilesè¡¨

```sql
-- éªŒè¯emailå­—æ®µå­˜åœ¨
SELECT column_name FROM information_schema.columns 
WHERE table_name = 'user_profiles' AND column_name = 'email';

-- éªŒè¯emailæ•°æ®å·²åŒæ­¥
SELECT id, email, display_name FROM user_profiles LIMIT 5;
```

### 2. æµ‹è¯•ç§¯åˆ†å‡½æ•°

```sql
-- æµ‹è¯•ç§¯åˆ†æŸ¥è¯¢
SELECT get_user_credits_v2('your-user-id'::uuid);

-- éªŒè¯ç§¯åˆ†è®°å½•
SELECT * FROM user_credit_balance LIMIT 5;
```

### 3. å‰ç«¯æµ‹è¯•

- ç™»å½•åº”ç”¨ï¼Œæ£€æŸ¥ç§¯åˆ†æ˜¯å¦æ­£å¸¸æ˜¾ç¤º
- è¿›è¡Œäººè„¸äº¤æ¢æ“ä½œï¼ŒéªŒè¯ç§¯åˆ†æ¶ˆè´¹
- æµ‹è¯•è®¢é˜…æµç¨‹ï¼Œç¡®è®¤çŠ¶æ€æ›´æ–°

## å¸¸è§é—®é¢˜

### Q: è„šæœ¬æ‰§è¡Œå¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**A:** æ£€æŸ¥ä»¥ä¸‹é¡¹ç›®ï¼š

1. ç¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®è®¾ç½®ï¼š
   ```bash
   echo $NEXT_PUBLIC_SUPABASE_URL
   echo $SUPABASE_SERVICE_ROLE_KEY
   ```

2. SupabaseæœåŠ¡è§’è‰²å¯†é’¥æƒé™æ˜¯å¦è¶³å¤Ÿ

3. æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸

### Q: å‰ç«¯ä»ç„¶æ— æ³•åŠ è½½ç§¯åˆ†ï¼Ÿ

**A:** è¯·æ£€æŸ¥ï¼š

1. å‰ç«¯æ˜¯å¦ä½¿ç”¨äº†æ­£ç¡®çš„å‡½æ•°åï¼ˆ`get_user_credits_v2`ï¼‰
2. ç”¨æˆ·æ˜¯å¦å·²ç™»å½•ä¸”æœ‰æœ‰æ•ˆçš„session
3. æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­çš„ç½‘ç»œè¯·æ±‚å’Œé”™è¯¯ä¿¡æ¯

### Q: è®¢é˜…çŠ¶æ€æœªæ›´æ–°ï¼Ÿ

**A:** è¯·æ£€æŸ¥ï¼š

1. Stripe webhookæ˜¯å¦æ­£ç¡®é…ç½®
2. webhookç«¯ç‚¹æ˜¯å¦èƒ½æ­£å¸¸æ¥æ”¶äº‹ä»¶
3. ç”¨æˆ·IDæ˜ å°„æ˜¯å¦æ­£ç¡®ï¼ˆæ£€æŸ¥customer metadataï¼‰

## æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š

1. åº”ç”¨æ—¥å¿—ï¼ˆæœåŠ¡å™¨æ§åˆ¶å°ï¼‰
2. Supabase Dashboardä¸­çš„æ—¥å¿—
3. Stripe Dashboardä¸­çš„webhookæ—¥å¿—

### æ—¥å¿—ä½ç½®

- **åº”ç”¨æ—¥å¿—**: æœåŠ¡å™¨æ§åˆ¶å°è¾“å‡º
- **Supabaseæ—¥å¿—**: Dashboard â†’ Logs
- **Stripeæ—¥å¿—**: Dashboard â†’ Developers â†’ Webhooks â†’ [Your Endpoint]

---

## æ€»ç»“

æ­¤ä¿®å¤æ–¹æ¡ˆå°†å½»åº•è§£å†³ï¼š

âœ… **user_profilesè¡¨ç¼ºå°‘emailå­—æ®µ**  
âœ… **å‰ç«¯ç§¯åˆ†åŠ è½½å¤±è´¥**  
âœ… **ç§¯åˆ†ç³»ç»Ÿåˆå§‹åŒ–é—®é¢˜**  
âœ… **è®¢é˜…çŠ¶æ€æ›´æ–°é—®é¢˜**  

ä¿®å¤åï¼Œæ‚¨çš„åº”ç”¨å°†æ‹¥æœ‰å®Œæ•´å¯é çš„ç”¨æˆ·é…ç½®å’Œç§¯åˆ†ç³»ç»Ÿã€‚ 